name: Build HQ Windows Static

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-win-static:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # ✅ 跳过 choco 安装，使用预装工具
    - name: Verify Preinstalled Tools
      shell: pwsh
      run: |
        Write-Host "=== Checking Preinstalled Tools ==="
        cmake --version
        ninja --version
        git --version
        xmake --version

    - name: Install xmake
      uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest

    - name: Setup MSVC Environment
      uses: ilammy/msvc-dev-cmd@v1

    # ✅ 添加缓存加速 Modest 编译
    - name: Cache Modest Build
      id: cache-modest
      uses: actions/cache@v4
      with:
        path: deps/modest
        key: modest-static-${{ runner.os }}-${{ hashFiles('deps/modest-src/**') }}
        restore-keys: |
          modest-static-${{ runner.os }}-

    - name: Build Modest (Static Libs)
      shell: pwsh
      run: |
        if (Test-Path "deps/modest/lib/myhtml.lib") {
          Write-Host "=== Using Cached Modest Build ==="
          exit 0
        }
        
        Write-Host "[1/4] Cloning Modest..."
        git clone --depth 1 https://github.com/lexborisov/Modest.git deps/modest-src
        
        Set-Location deps/modest-src
        
        Write-Host "[2/4] Patching CMakeLists.txt for Windows..."
        $content = Get-Content -Raw -Path 'CMakeLists.txt'
        $content = $content -replace 'find_package\(Threads REQUIRED\)', 'find_package(Threads)'
        $content = $content -replace 'message\(FATAL_ERROR.*[Pp]thread', 'message(WARNING "pthread not found, using Windows native threads"'
        Set-Content -Path 'CMakeLists.txt' -Value $content
        
        Set-Location ..
        New-Item -ItemType Directory -Force -Path modest-src/build_static | Out-Null
        Set-Location modest-src/build_static
        
        Write-Host "[3/4] Configuring Modest..."
        cmake .. `
          -G "Ninja" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF `
          -DCMAKE_INSTALL_PREFIX="../install" `
          -DCMAKE_C_FLAGS="/MT" `
          -DCMAKE_CXX_FLAGS="/MT" `
          -DCMAKE_THREAD_PREFER_PTHREAD=OFF
        
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
        Write-Host "[4/4] Building and Installing..."
        cmake --build . --config Release
        if ($LASTEXITCODE -ne 0) { exit 1 }
        
        cmake --install . --config Release
        
        Set-Location ..
        if (Test-Path ..\modest) { Remove-Item -Recurse -Force ..\modest }
        New-Item -ItemType Directory -Path ..\modest\include | Out-Null
        New-Item -ItemType Directory -Path ..\modest\lib | Out-Null
        Move-Item -Path install\include -Destination ..\modest\
        Move-Item -Path install\lib -Destination ..\modest\
        
        Write-Host "Modest build complete!"

    - name: Configure HQ with xmake
      shell: cmd
      run: |
        xmake f -p windows -a x64 -m release --yes
        xmake build -v

    - name: Verify and Upload
      shell: pwsh
      run: |
        $buildDir = xmake show project.buildir
        $exePath = Get-ChildItem -Recurse -Path $buildDir -Filter "hq.exe" | Select-Object -First 1
        
        if ($null -eq $exePath) {
          Write-Error "hq.exe not found!"
          exit 1
        }
        
        Copy-Item $exePath.FullName -Destination "hq.exe"
        
        Write-Host "=== Dependency Check ==="
        dumpbin /dependents "hq.exe"
        
        Write-Host "=== Functional Test ==="
        echo "<h1>Static Build OK</h1>" | .\hq.exe h1 text

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: hq-windows-static-x64
        path: hq.exe
        retention-days: 30
