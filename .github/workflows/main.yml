name: Build HQ Windows Static

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-win-static:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install CMake and Ninja
      run: |
        choco install cmake ninja -y --no-progress
        refreshenv

    - name: Install xmake
      uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest

    - name: Setup MSVC Environment
      uses: ilammy/msvc-dev-cmd@v1

    - name: Build Modest (Static Libs)
      shell: cmd
      run: |
        echo [1/4] Cloning Modest...
        git clone --depth 1 https://github.com/lexborisov/Modest.git deps/modest-src
        
        cd deps/modest-src
        
        echo [2/4] Applying Windows-compatible CMake patch...
        rem 只修改 pthread 检查，不影响其他功能
        powershell -Command ^(
          $c = Get-Content -Raw 'CMakeLists.txt'; ^
          $c = $c -replace 'find_package\\(Threads REQUIRED\\)', 'find_package(Threads)'; ^
          $c = $c -replace 'message\\(FATAL_ERROR.*[Pp]thread.*\\)', 'message(WARNING "pthread not found, using Windows native threads")'; ^
          Set-Content -Path 'CMakeLists.txt' -Value $c ^
        )
        
        mkdir build_static
        cd build_static
        
        echo [3/4] Configuring Modest...
        cmake .. -G "Ninja" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DBUILD_SHARED_LIBS=OFF ^
          -DCMAKE_INSTALL_PREFIX="../install" ^
          -DCMAKE_C_FLAGS="/MT" ^
          -DCMAKE_CXX_FLAGS="/MT" ^
          -DCMAKE_THREAD_PREFER_PTHREAD=OFF
        
        if %ERRORLEVEL% neq 0 (
          echo CMake config failed!
          exit /b 1
        )
        
        echo [4/4] Building and Installing...
        cmake --build . --config Release
        cmake --install . --config Release
        
        cd ..
        if exist ..\modest rmdir /s /q ..\modest
        mkdir ..\modest
        move install\include ..\modest\
        move install\lib ..\modest\
        
        echo Modest build complete!
        dir ..\modest\lib

    - name: Configure HQ with xmake
      shell: cmd
      run: |
        xmake f -p windows -a x64 -m release --yes
        xmake build -v

    - name: Verify and Upload
      shell: pwsh
      run: |
        $buildDir = xmake show project.buildir
        $exePath = Get-ChildItem -Recurse -Path $buildDir -Filter "hq.exe" | Select-Object -First 1
        Copy-Item $exePath.FullName -Destination "hq.exe"
        
        Write-Host "=== Dependency Check ==="
        dumpbin /dependents "hq.exe"
        
        Write-Host "=== Test ==="
        echo "<h1>Test</h1>" | .\hq.exe h1 text

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: hq-windows-static-x64
        path: hq.exe
