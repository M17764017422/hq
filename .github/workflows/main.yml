name: Build HQ Windows Static

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-win-static:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Verify Preinstalled Tools
      shell: pwsh
      run: |
        cmake --version
        ninja --version

    - name: Install xmake
      uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest

    - name: Setup MSVC Environment
      uses: ilammy/msvc-dev-cmd@v1

    - name: Cache Modest Build
      id: cache-modest
      uses: actions/cache@v4
      with:
        path: deps/modest
        key: modest-static-${{ runner.os }}-${{ hashFiles('deps/modest-src/**') }}
        restore-keys: |
          modest-static-${{ runner.os }}-

    - name: Build Modest (Static Libs)
      shell: pwsh
      run: |
        if (Test-Path "deps/modest/lib/myhtml.lib") {
          Write-Host "=== Using Cached Modest Build ==="
          exit 0
        }
        
        Write-Host "[1/4] Cloning Modest..."
        git clone --depth 1 https://github.com/lexborisov/Modest.git deps/modest-src
        
        Set-Location deps/modest-src
        
        Write-Host "[2/4] Patching CMakeLists.txt for Windows..."
        
        $lines = Get-Content -Path 'CMakeLists.txt'
        $newLines = @()
        
        foreach ($line in $lines) {
            if ($line -match 'find_package\(Threads REQUIRED\)') {
                $newLines += $line -replace 'REQUIRED', ''
                Write-Host "  Patched: find_package(Threads)"
            }
            elseif ($line -match 'message\(FATAL_ERROR.*[Pp]thread') {
                $newLines += $line -replace 'FATAL_ERROR', 'WARNING'
                Write-Host "  Patched: FATAL_ERROR -> WARNING"
            }
            elseif ($line -match 'if\s*\(\s*NOT\s+CMAKE_USE_PTHREADS_INIT\s*\)') {
                $newLines += 'if(FALSE)  # Disabled for Windows'
                Write-Host "  Patched: pthread check disabled"
            }
            else {
                $newLines += $line
            }
        }
        
        $newLines | Set-Content -Path 'CMakeLists.txt' -Encoding UTF8
        
        Set-Location ..
        
        # ✅ 清理并重建 build 目录
        if (Test-Path modest-src/build_static) {
            Remove-Item -Recurse -Force modest-src/build_static
        }
        New-Item -ItemType Directory -Force -Path modest-src/build_static | Out-Null
        Set-Location modest-src/build_static
        
        Write-Host "[3/4] Configuring Modest..."
        cmake .. `
          -G "Ninja" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF `
          -DCMAKE_INSTALL_PREFIX="../install" `
          -DCMAKE_C_FLAGS="/MT" `
          -DCMAKE_CXX_FLAGS="/MT" `
          -DCMAKE_THREAD_PREFER_PTHREAD=OFF `
          -DTHREADS_PREFER_PTHREAD_FLAG=OFF
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "CMake configuration failed!"
          exit 1
        }
        
        Write-Host "[4/4] Building and Installing..."
        cmake --build . --config Release -j $env:NUMBER_OF_PROCESSORS
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Modest build failed!"
          exit 1
        }
        
        cmake --install . --config Release
        
        Set-Location ..
        
        # ✅ 清理目标目录后再移动
        if (Test-Path ..\modest) {
            Remove-Item -Recurse -Force ..\modest
        }
        New-Item -ItemType Directory -Force -Path ..\modest | Out-Null
        
        # ✅ 使用 Copy-Item 并保留目录结构
        Copy-Item -Path install\include -Destination ..\modest\include -Recurse -Force
        Copy-Item -Path install\lib -Destination ..\modest\lib -Recurse -Force
        
        Write-Host "Modest build complete!"
        Get-ChildItem -Path ..\modest\lib

    - name: Configure HQ with xmake
      shell: cmd
      run: |
        xmake f -p windows -a x64 -m release --yes
        xmake build -v

    - name: Verify and Upload
      shell: pwsh
      run: |
        $buildDir = xmake show project.buildir
        $exePath = Get-ChildItem -Recurse -Path $buildDir -Filter "hq.exe" | Select-Object -First 1
        
        if ($null -eq $exePath) {
          Write-Error "hq.exe not found!"
          exit 1
        }
        
        Copy-Item $exePath.FullName -Destination "hq.exe"
        
        Write-Host "=== Dependency Check ==="
        dumpbin /dependents "hq.exe"
        
        Write-Host "=== Functional Test ==="
        echo "<h1>Static Build OK</h1>" | .\hq.exe h1 text

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: hq-windows-static-x64
        path: hq.exe
        retention-days: 30
